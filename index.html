<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Color Visualizer — Fixed</title>
  <style>
    :root{
      --bg: #0e1624;
      --text: #e8eefc;
      --muted: #aab6d6;
      --panel: rgba(255,255,255,0.06);
      --panel-border: rgba(255,255,255,0.18);
      --accent: #1f6feb;
      --btn-text: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --blur: blur(8px) saturate(1.1);
    }
    :root[data-theme="light"]{
      --bg: #f5f7fb;
      --text: #0f1a2b;
      --muted: #4a5a78;
      --panel: rgba(255,255,255,0.92);
      --panel-border: rgba(10,20,40,0.08);
      --accent: #2563eb;
      --btn-text: #ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,0.15);
      --blur: none;
    }
    html, body { height:100%; margin:0; background: var(--bg); color: var(--text); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans", "Helvetica Neue", Arial; }
    #app { position: fixed; inset: 0; overflow: hidden; }
    canvas { position:absolute; inset:0; width:100%; height:100%; display:block; }
    .labels { position:absolute; inset:0; pointer-events:none; }
    .glass { background: var(--panel); border:1px solid var(--panel-border); border-radius:20px; box-shadow: var(--shadow); backdrop-filter: var(--blur); }

    .welcome { width:min(520px, 92vw); padding:22px; text-align:center; pointer-events:auto; }
    .logo { width:90px; height:90px; margin:0 auto 10px; display:flex; align-items:center; justify-content:center; border-radius:18px; background: rgba(255,255,255,0.08); }
    .title { font-size:24px; letter-spacing:1px; margin:10px 0 6px; }
    .sub { opacity:0.85; margin:0 0 16px; }
    .btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 16px; border:none; border-radius:14px; background: var(--accent); color:var(--btn-text); font-weight:700; cursor:pointer; }

    .controls-card { width:min(420px, 92vw); padding:14px; pointer-events:auto; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .group { border:1px dashed var(--panel-border); border-radius:14px; padding:10px; }
    h4 { margin:0 0 8px; font-size:14px; }
    label { font-size:13px; display:block; margin-bottom:6px; }
    input[type="color"]{ width:100%; height:36px; border:1px solid var(--panel-border); border-radius:10px; background:transparent; padding:0; cursor:pointer; }
    input[type="range"]{ width:100%; }
    .row{ display:flex; gap:10px; align-items:center; }
    .row>*{ flex:1; }
    .small{ font-size:12px; opacity:0.8; }

    .theme { position:absolute; top:12px; left:12px; width:44px; height:44px; display:flex; align-items:center; justify-content:center; border-radius:50%; border:1px solid var(--panel-border); background: var(--panel); cursor:pointer; pointer-events:auto; }
  </style>
</head>
<body>
  <div id="app"></div>

  <script type="module">
    import * as THREE from 'https://unpkg.com/three@0.164.0/build/three.module.js';
    import { OrbitControls } from 'https://unpkg.com/three@0.164.0/examples/jsm/controls/OrbitControls.js';
    import { CSS2DRenderer, CSS2DObject } from 'https://unpkg.com/three@0.164.0/examples/jsm/renderers/CSS2DRenderer.js';

    const savedTheme = localStorage.getItem('cv_theme') || 'dark';
    document.documentElement.setAttribute('data-theme', savedTheme);

    const app = document.getElementById('app');

    // WebGL
    const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
    renderer.setPixelRatio(Math.min(window.devicePixelRatio || 1, 2));
    renderer.setSize(innerWidth, innerHeight);
    renderer.outputColorSpace = THREE.SRGBColorSpace;
    app.appendChild(renderer.domElement);

    // CSS2D
    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(innerWidth, innerHeight);
    labelRenderer.domElement.className = 'labels';
    app.appendChild(labelRenderer.domElement);

    // Scene
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(60, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(3.2, 1.8, 4.5);
    scene.add(camera);

    const controls = new OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.target.set(0, 1.2, 0);

    // Resize
    addEventListener('resize', () => {
      camera.aspect = innerWidth/innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
      labelRenderer.setSize(innerWidth, innerHeight);
    });

    // Lights
    const hemi = new THREE.HemisphereLight(0xffffff, 0x333333, 0.6);
    hemi.position.set(0, 2, 0);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 1.0);
    dir.position.set(2.5, 3.2, 2.2);
    scene.add(dir);

    // Floor
    const floorGeo = new THREE.PlaneGeometry(4,3);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 1.0 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI/2;
    scene.add(floor);

    // Walls
    const walls = [];
    function makeWall(w,h,color){
      const mesh = new THREE.Mesh(new THREE.PlaneGeometry(w,h), new THREE.MeshStandardMaterial({ color }));
      return mesh;
    }
    function buildRoom(len=4, wid=3, hei=2.8, colors=['#d9d3c7','#d9d3c7','#d9d3c7','#d9d3c7']){
      walls.forEach(w => scene.remove(w));
      walls.length = 0;
      const w1 = makeWall(len, hei, colors[0]); w1.position.set(0, hei/2, wid/2); w1.rotation.y = Math.PI;
      const w2 = makeWall(len, hei, colors[1]); w2.position.set(0, hei/2, -wid/2);
      const w3 = makeWall(wid, hei, colors[2]); w3.position.set(len/2, hei/2, 0); w3.rotation.y = -Math.PI/2;
      const w4 = makeWall(wid, hei, colors[3]); w4.position.set(-len/2, hei/2, 0); w4.rotation.y = Math.PI/2;
      [w1,w2,w3,w4].forEach(w => { scene.add(w); walls.push(w); });
      floor.geometry.dispose(); floor.geometry = new THREE.PlaneGeometry(len, wid);
    }
    buildRoom();

    // Kelvin
    function kelvinToRGB(k) {
      const t = Math.max(1000, Math.min(40000, k)) / 100;
      let r,g,b;
      if (t <= 66) { r = 255; g = 99.4708025861 * Math.log(t) - 161.1195681661; b = t <= 19 ? 0 : (138.5177312231 * Math.log(t - 10) - 305.0447927307); }
      else { r = 329.698727446 * Math.pow(t - 60, -0.1332047592); g = 288.1221695283 * Math.pow(t - 60, -0.0755148492); b = 255; }
      const clamp = v => Math.max(0, Math.min(255, v));
      return new THREE.Color(clamp(r)/255, clamp(g)/255, clamp(b)/255);
    }
    function applyKelvin(k){
      const c = kelvinToRGB(k);
      dir.color.copy(c);
      hemi.color.copy(c.clone().multiplyScalar(0.9));
      const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
      renderer.setClearColor(isDark ? 0x0e1624 : 0xf5f7fb, 1);
    }
    applyKelvin(3000);

    // ------------- UI via CSS2DObject -------------
    function makeWelcomeCard(){
      const el = document.createElement('div');
      el.className = 'glass welcome';
      el.innerHTML = `
        <div class="logo">
          <svg viewBox="0 0 64 64" width="64" height="64" aria-hidden="true">
            <g fill="none" stroke="currentColor" stroke-width="2">
              <rect x="6" y="10" width="36" height="12" rx="3" ry="3" fill="currentColor" opacity="0.12"></rect>
              <rect x="6" y="10" width="36" height="12" rx="3" ry="3"></rect>
              <path d="M42 16h6a4 4 0 0 1 4 4v10" />
              <rect x="50" y="28" width="10" height="22" rx="3" ry="3" fill="currentColor" opacity="0.12"></rect>
              <rect x="50" y="28" width="10" height="22" rx="3" ry="3"></rect>
              <rect x="28" y="22" width="10" height="8" rx="2" ry="2" fill="currentColor" opacity="0.12"></rect>
              <rect x="28" y="22" width="10" height="8" rx="2" ry="2"></rect>
              <path d="M33 30v8" />
            </g>
          </svg>
        </div>
        <div class="title">COLOR VISUALIZER</div>
        <div class="sub">غيّر لون أوضتك وشوف الشكل قبل ما تدهن.</div>
        <button id="start" class="btn">Get Started</button>
      `;
      const obj = new CSS2DObject(el);
      obj.position.set(0, 1.4, -2.4);
      return { el, obj };
    }

    function makeControlsCard(){
      const el = document.createElement('div');
      el.className = 'glass controls-card';
      el.style.display = 'none';
      el.innerHTML = `
        <div class="grid">
          <div class="group">
            <h4>ألوان الحيطان</h4>
            <label>الحائط 1</label><input id="w1" type="color" value="#d9d3c7">
            <label>الحائط 2</label><input id="w2" type="color" value="#d9d3c7">
            <label>الحائط 3</label><input id="w3" type="color" value="#d9d3c7">
            <label>الحائط 4</label><input id="w4" type="color" value="#d9d3c7">
          </div>
          <div class="group">
            <h4>الإضاءة (Kelvin)</h4>
            <div class="row">
              <input id="kelvin" type="range" min="1000" max="7000" step="500" value="3000">
              <span id="kLabel" class="small">3000K</span>
            </div>
            <div class="row small">
              <span>1000K</span><span style="text-align:center">دافئة</span><span style="text-align:end">7000K</span>
            </div>
          </div>
        </div>
      `;
      const obj = new CSS2DObject(el);
      obj.position.set(0, 1.2, -1.8);
      return { el, obj };
    }

    const { el: welcomeEl, obj: welcomeObj } = makeWelcomeCard();
    camera.add(welcomeObj);

    const { el: controlsEl, obj: controlsObj } = makeControlsCard();
    camera.add(controlsObj);

    // Theme button (absolute overlay, stable)
    const themeBtn = document.createElement('div');
    themeBtn.className = 'theme';
    themeBtn.innerHTML = `
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
      </svg>
    `;
    themeBtn.style.position = 'absolute';
    themeBtn.style.top = '12px';
    themeBtn.style.left = '12px';
    themeBtn.style.pointerEvents = 'auto';
    labelRenderer.domElement.appendChild(themeBtn);

    // Start interaction
    welcomeEl.querySelector('#start').addEventListener('click', () => {
      welcomeEl.style.display = 'none';
      controlsEl.style.display = 'block';
      localStorage.setItem('cv_seen_fixed', '1');
    });
    if (localStorage.getItem('cv_seen_fixed') === '1') {
      welcomeEl.style.display = 'none';
      controlsEl.style.display = 'block';
    }

    // Controls wiring
    ['w1','w2','w3','w4'].forEach((id, idx) => {
      controlsEl.querySelector('#' + id).addEventListener('input', e => {
        walls[idx].material.color = new THREE.Color(e.target.value);
      });
    });
    const kSlider = controlsEl.querySelector('#kelvin');
    const kLabel = controlsEl.querySelector('#kLabel');
    kSlider.addEventListener('input', () => {
      kLabel.textContent = kSlider.value + 'K';
      applyKelvin(parseInt(kSlider.value,10));
    });

    // Theme toggle
    themeBtn.addEventListener('click', () => {
      const cur = document.documentElement.getAttribute('data-theme');
      const next = cur === 'light' ? 'dark' : 'light';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('cv_theme', next);
      applyKelvin(parseInt(kSlider.value,10));
    });

    // Animate
    function animate(){
      requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
      labelRenderer.render(scene, camera);
    }
    animate();
  </script>
</body>
</html>
